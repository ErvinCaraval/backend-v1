name: Dependency Security Check

on:
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar diariamente a las 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: |
        echo "🔍 Running security audit..."
        npm audit --audit-level=moderate --json > audit-results.json || true
        
        # Procesar resultados del audit
        if [ -f audit-results.json ]; then
          echo "📊 Audit Results:"
          cat audit-results.json | jq '.metadata.vulnerabilities // {}'
          
          # Contar vulnerabilidades por severidad
          CRITICAL=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
          MODERATE=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
          LOW=$(cat audit-results.json | jq '.metadata.vulnerabilities.low // 0')
          
          echo "📈 Vulnerability Summary:"
          echo "  Critical: $CRITICAL"
          echo "  High: $HIGH"
          echo "  Moderate: $MODERATE"
          echo "  Low: $LOW"
          
          # Fallar si hay vulnerabilidades críticas o altas
          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "❌ Found critical or high severity vulnerabilities!"
            echo "Please update dependencies to fix these issues."
            exit 1
          else
            echo "✅ No critical or high severity vulnerabilities found"
          fi
        fi
    
    - name: Check for outdated dependencies
      run: |
        echo "🔄 Checking for outdated dependencies..."
        npm outdated --json > outdated-deps.json || true
        
        if [ -f outdated-deps.json ]; then
          OUTDATED_COUNT=$(cat outdated-deps.json | jq 'length')
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "⚠️ Found $OUTDATED_COUNT outdated dependencies:"
            cat outdated-deps.json | jq -r 'to_entries[] | "  \(.key): \(.value.current) -> \(.value.latest)"'
            echo "Consider updating these dependencies for better security and features."
          else
            echo "✅ All dependencies are up to date"
          fi
        fi
    
    - name: Generate dependency report
      if: always()
      run: |
        echo "📋 Generating dependency report..."
        
        # Crear reporte en formato markdown
        cat > dependency-report.md << EOF
        # Dependency Security Report
        
        Generated on: $(date)
        Branch: ${{ github.ref_name }}
        Commit: ${{ github.sha }}
        
        ## Security Audit Results
        
        EOF
        
        if [ -f audit-results.json ]; then
          cat audit-results.json | jq -r '
            "| Severity | Count |\n|----------|-------|\n" +
            "| Critical | \(.metadata.vulnerabilities.critical // 0) |\n" +
            "| High | \(.metadata.vulnerabilities.high // 0) |\n" +
            "| Moderate | \(.metadata.vulnerabilities.moderate // 0) |\n" +
            "| Low | \(.metadata.vulnerabilities.low // 0) |"
          ' >> dependency-report.md
        fi
        
        echo "" >> dependency-report.md
        echo "## Outdated Dependencies" >> dependency-report.md
        echo "" >> dependency-report.md
        
        if [ -f outdated-deps.json ]; then
          cat outdated-deps.json | jq -r '
            "| Package | Current | Latest |\n|---------|---------|--------|\n" +
            (to_entries[] | "| \(.key) | \(.value.current) | \(.value.latest) |")
          ' >> dependency-report.md
        fi
        
        echo "📄 Report generated: dependency-report.md"
    
    - name: Upload dependency report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: |
          audit-results.json
          outdated-deps.json
          dependency-report.md
        retention-days: 30